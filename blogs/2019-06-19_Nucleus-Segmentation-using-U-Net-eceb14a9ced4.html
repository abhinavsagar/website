<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Nucleus Segmentation using U-Net</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Nucleus Segmentation using U-Net</h1>
</header>
<section data-field="subtitle" class="p-summary">
How deep learning can be used for segmenting medical images ?
</section>
<section data-field="body" class="e-content">
<section name="d706" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="1de6" id="1de6" class="graf graf--h3 graf--leading graf--title">Nucleus Segmentation using U-Net</h3><h4 name="8708" id="8708" class="graf graf--h4 graf-after--h3 graf--subtitle">How can deep learning be used for segmenting medical images ?</h4></div><div class="section-inner sectionLayout--fullWidth"><figure name="2e22" id="2e22" class="graf graf--figure graf--layoutFillWidth graf-after--h4"><img class="graf-image" data-image-id="1*bWCWgKScOf0blEfZxlcg-g.png" data-width="1518" data-height="1398" src="https://cdn-images-1.medium.com/max/2560/1*bWCWgKScOf0blEfZxlcg-g.png"></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="6c36" id="6c36" class="graf graf--p graf-after--figure">Stuck behind the paywall? Click <a href="https://medium.com/p/nucleus-segmentation-using-u-net-eceb14a9ced4?source=email-c3f5233f3441--writer.postDistributed&amp;sk=881ef594402fb347d56e1c12f077732d" data-href="https://medium.com/p/nucleus-segmentation-using-u-net-eceb14a9ced4?source=email-c3f5233f3441--writer.postDistributed&amp;sk=881ef594402fb347d56e1c12f077732d" class="markup--anchor markup--p-anchor" target="_blank">here</a> to read the full story with my Friend Link!</p><p name="ceb0" id="ceb0" class="graf graf--p graf-after--p">Automatic segmentation of microscopy images is an important task in medical image processing and analysis. Nucleus detection is an important example of this task. Imagine speeding up research for almost every disease, from lung cancer and heart disease to rare disorders. The <a href="https://www.kaggle.com/c/data-science-bowl-2018" data-href="https://www.kaggle.com/c/data-science-bowl-2018" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">2018 Data Science Bowl</strong></a> offers our most ambitious mission yet: create an algorithm to automate nucleus detection. We’ve all seen people suffer from diseases like cancer, heart disease, chronic obstructive pulmonary disease, Alzheimer’s, and diabetes. Think how many lives would be transformed if cures came faster. By automating nucleus detection, you could help unlock cures faster from rare disorders to the common cold.</p><p name="cbec" id="cbec" class="graf graf--p graf-after--p graf--trailing">This project is a part of the Data Science Bowl 2018 held on Kaggle.</p></div></div></section><section name="b925" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="f0fd" id="f0fd" class="graf graf--h3 graf--leading">Environment and tools</h3><ol class="postList"><li name="0c76" id="0c76" class="graf graf--li graf-after--h3">scikit-learn</li><li name="4db7" id="4db7" class="graf graf--li graf-after--li">scikit-Image</li><li name="fd05" id="fd05" class="graf graf--li graf-after--li">numpy</li><li name="ba8c" id="ba8c" class="graf graf--li graf-after--li">keras</li><li name="f1fe" id="f1fe" class="graf graf--li graf-after--li">pandas</li><li name="2c71" id="2c71" class="graf graf--li graf-after--li">matplotlib</li><li name="0f75" id="0f75" class="graf graf--li graf-after--li">tensorflow</li></ol><h3 name="6af9" id="6af9" class="graf graf--h3 graf-after--li">Data</h3><p name="04d3" id="04d3" class="graf graf--p graf-after--h3">The data can be downloaded from the kaggle website which can be found <a href="https://www.kaggle.com/c/data-science-bowl-2018/data" data-href="https://www.kaggle.com/c/data-science-bowl-2018/data" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">here</strong></a>.</p><h3 name="9d24" id="9d24" class="graf graf--h3 graf-after--p">Basics</h3><p name="eb1a" id="eb1a" class="graf graf--p graf-after--h3">This is a typical instance segmentation problem. Two architectures which have been highly successful at this are U-Net and Mask-R-CNN. I have used U-Net in this project.</p><ul class="postList"><li name="1ffe" id="1ffe" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Image Classification</strong>: Classify the main object category within an image.</li><li name="b6f0" id="b6f0" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Object Detection</strong>: Identify the object category and locate the position using a bounding box for every known object within an image.</li><li name="a8af" id="a8af" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Semantic Segmentation</strong>: Identify the object category of each pixel for every known object within an image. <strong class="markup--strong markup--li-strong">Labels are class-aware.</strong></li><li name="1e86" id="1e86" class="graf graf--li graf-after--li graf--trailing"><strong class="markup--strong markup--li-strong">Instance Segmentation</strong>: Identify each object instance of each pixel for every known object within an image. <strong class="markup--strong markup--li-strong">Labels are instance-aware.</strong></li></ul></div></div></section><section name="692a" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="bdad" id="bdad" class="graf graf--h3 graf--leading">Where is the code?</h3><p name="0924" id="0924" class="graf graf--p graf-after--h3">Without much ado, let’s get started with the code. The complete project on github can be found <a href="https://github.com/abhinavsagar/Kaggle-tutorial" data-href="https://github.com/abhinavsagar/Kaggle-tutorial" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">here</a>.</p><p name="3748" id="3748" class="graf graf--p graf-after--p">Let’s start with loading all the libraries and dependencies.</p><figure name="000c" id="000c" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/abhinavsagar/b30ccc4370b4d2d5f5df7df991c64989.js"></script></figure><p name="e320" id="e320" class="graf graf--p graf-after--figure">We should also set some of the parameter values and load the training and test set images.</p><figure name="6ea5" id="6ea5" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/abhinavsagar/8dfc256dc776cdffca851091db5d84c7.js"></script></figure><p name="8a8f" id="8a8f" class="graf graf--p graf-after--figure">Next we should prepare the data in the form we want. To reduce the computational complexity we need to resize all the images.</p><figure name="6cc6" id="6cc6" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/abhinavsagar/2676e636c21d9a0e2f149c7190ffd46d.js"></script></figure><figure name="c3a7" id="c3a7" class="graf graf--figure graf--iframe graf-after--figure"><script src="https://gist.github.com/abhinavsagar/1cca50017f286db5f8f1baa465893224.js"></script></figure><figure name="849c" id="849c" class="graf graf--figure graf--iframe graf-after--figure"><script src="https://gist.github.com/abhinavsagar/4734777c90e34582b23c41da7fb97bdc.js"></script></figure><p name="6f48" id="6f48" class="graf graf--p graf-after--figure">The next step is probably the most important part of the project yet neglected most of the times. Yes, that is data augmentation. I have used shearing of images to overcome overfitting. Since the dataset size is small in this case, overfitting is not a major problem here.</p><figure name="979c" id="979c" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/abhinavsagar/4df0cbc923f136330de0a315996312d7.js"></script></figure><p name="51f4" id="51f4" class="graf graf--p graf-after--figure">Let’s display some microscopic images with and without segmentation.</p><figure name="0b2e" id="0b2e" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/abhinavsagar/7c692227ae20b767a1861e6690f40a32.js"></script></figure><figure name="0d09" id="0d09" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*aHPbJFapSNuC4pF3AHN56w.png" data-width="289" data-height="280" src="https://cdn-images-1.medium.com/max/800/1*aHPbJFapSNuC4pF3AHN56w.png"><figcaption class="imageCaption">without segmentation</figcaption></figure><figure name="9513" id="9513" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*FnPBci7hh6jY1qZ4z_XVrQ.png" data-width="324" data-height="280" src="https://cdn-images-1.medium.com/max/800/1*FnPBci7hh6jY1qZ4z_XVrQ.png"><figcaption class="imageCaption">with segmentation</figcaption></figure><p name="4f14" id="4f14" class="graf graf--p graf-after--figure">Let’s also create a generator that generates masks and images.</p><figure name="701d" id="701d" class="graf graf--figure graf--iframe graf-after--p graf--trailing"><script src="https://gist.github.com/abhinavsagar/1757b92064745c26a2db26603f36cfee.js"></script></figure></div></div></section><section name="a563" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c479" id="c479" class="graf graf--h3 graf--leading">U-Net</h3><p name="04f3" id="04f3" class="graf graf--p graf-after--h3">The architecture looks like a ‘U’ which justifies its name. This architecture consists of three sections: The contraction, The bottleneck, and the expansion section. The contraction section is made of many contraction blocks. Each block takes an input and applies two 3X3 convolution layers followed by a 2X2 max pooling. The number of kernels or feature maps after each block doubles so that architecture can learn the complex structures effectively. The bottom-most layer lies between the contraction layer and the expansion layer.</p><p name="651b" id="651b" class="graf graf--p graf-after--p">But the heart of this architecture lies in the expansion section. Similar to contraction layer, it also consists of several expansion blocks. Each block passes the input to two 3X3 CNN layers followed by a 2X2 up-sampling layer. Also after each block number of feature maps used by convolutional layer get half to maintain symmetry. The number of expansion blocks is as same as the number of contraction block. After that the resultant mapping passes through another 3X3 CNN layer with the number of feature maps equal to the number of segments desired.</p><figure name="5a15" id="5a15" class="graf graf--figure graf-after--p graf--trailing"><img class="graf-image" data-image-id="1*kINgQvvpTboU0gfCpsujCQ.png" data-width="800" data-height="532" src="https://cdn-images-1.medium.com/max/800/1*kINgQvvpTboU0gfCpsujCQ.png"><figcaption class="imageCaption">U-net architecture</figcaption></figure></div></div></section><section name="c781" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="b564" id="b564" class="graf graf--p graf--leading">Let’s continue with defining the<a href="https://en.wikipedia.org/wiki/Jaccard_index" data-href="https://en.wikipedia.org/wiki/Jaccard_index" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong"> Intersection over Union</strong></a> (IOU) metric.</p><figure name="953a" id="953a" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/abhinavsagar/0a0ad1fc36491a634e36f157a66aaac2.js"></script></figure><p name="2e39" id="2e39" class="graf graf--p graf-after--figure">Then we should build the U-Net model as shown in the above picture using keras layers.</p><figure name="2ed3" id="2ed3" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/abhinavsagar/fe0c900133cafe93194c069fe655ef6e.js"></script></figure><p name="a271" id="a271" class="graf graf--p graf-after--figure">I have trained the model for three iterations using early-stopping criterion as a parameter and it gives fairly good results with a mean IOU of 0.416. Feel free to play with the hyper-parameters here.</p><figure name="b62c" id="b62c" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/abhinavsagar/9ee8e1426adf6a559bc2466f2409101f.js"></script></figure><p name="d7e7" id="d7e7" class="graf graf--p graf-after--figure">Finally I wrote a bunch of lines for the final predictions.</p><figure name="b2c3" id="b2c3" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/abhinavsagar/821190cb14c82e6e4dc6401afcb18cff.js"></script></figure><h3 name="85d3" id="85d3" class="graf graf--h3 graf-after--figure">Results</h3><figure name="543d" id="543d" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="1*Hh-YPHGObYa94w61rcfWhA.png" data-width="473" data-height="466" src="https://cdn-images-1.medium.com/max/800/1*Hh-YPHGObYa94w61rcfWhA.png"></figure><figure name="f328" id="f328" class="graf graf--figure graf-after--figure graf--trailing"><img class="graf-image" data-image-id="1*0wH8KF_dwM6h1KRgVjRBJQ.png" data-width="473" data-height="466" src="https://cdn-images-1.medium.com/max/800/1*0wH8KF_dwM6h1KRgVjRBJQ.png"></figure></div></div></section><section name="b1f8" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="6899" id="6899" class="graf graf--h3 graf--leading">Conclusions</h3><p name="ab6f" id="ab6f" class="graf graf--p graf-after--h3 graf--trailing">This was one of the most challenging projects that I have worked on and at the same time was quite fun too. Although this was not one of the typical computer vision projects where computational complexity was a challenge, but it was more about finding small features in relatively larger sized images. Honestly to the naked eye, segmenting nucleus in an image is a challenge. Sometimes even an expert might make a mistake in this so automating the full pipeline, looks like the future of nucleus segmentation.</p></div></div></section><section name="a344" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="a744" id="a744" class="graf graf--h3 graf--leading">References/Further Readings</h3><div name="f010" id="f010" class="graf graf--mixtapeEmbed graf-after--h3"><a href="https://arxiv.org/abs/1505.04597" data-href="https://arxiv.org/abs/1505.04597" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://arxiv.org/abs/1505.04597"><strong class="markup--strong markup--mixtapeEmbed-strong">U-Net: Convolutional Networks for Biomedical Image Segmentation</strong><br><em class="markup--em markup--mixtapeEmbed-em">There is large consent that successful training of deep networks requires many thousand annotated training samples. In…</em>arxiv.org</a><a href="https://arxiv.org/abs/1505.04597" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="30a7d38df7f3687fcdfb762e90e2e537"></a></div><div name="ac82" id="ac82" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed"><a href="https://www.kaggle.com/c/data-science-bowl-2018" data-href="https://www.kaggle.com/c/data-science-bowl-2018" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://www.kaggle.com/c/data-science-bowl-2018"><strong class="markup--strong markup--mixtapeEmbed-strong">2018 Data Science Bowl</strong><br><em class="markup--em markup--mixtapeEmbed-em">Find the nuclei in divergent images to advance medical discovery</em>www.kaggle.com</a><a href="https://www.kaggle.com/c/data-science-bowl-2018" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="ae73f64c624426e29048f1158479415f" data-thumbnail-img-id="0*ziplj3nNGruPvKAE" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*ziplj3nNGruPvKAE);"></a></div><div name="26ab" id="26ab" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed graf--trailing"><a href="https://towardsdatascience.com/review-u-net-biomedical-image-segmentation-d02bf06ca760" data-href="https://towardsdatascience.com/review-u-net-biomedical-image-segmentation-d02bf06ca760" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://towardsdatascience.com/review-u-net-biomedical-image-segmentation-d02bf06ca760"><strong class="markup--strong markup--mixtapeEmbed-strong">Review: U-Net (Biomedical Image Segmentation)</strong><br><em class="markup--em markup--mixtapeEmbed-em">In this story, U-Net is reviewed. U-Net is one of the famous Fully Convolutional Networks (FCN) in biomedical image…</em>towardsdatascience.com</a><a href="https://towardsdatascience.com/review-u-net-biomedical-image-segmentation-d02bf06ca760" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="4b56f008c8f757cd116101a7032c3400" data-thumbnail-img-id="0*a0ab8c72FHL7rvQk.gif" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*a0ab8c72FHL7rvQk.gif);"></a></div></div></div></section><section name="a7f3" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="aa19" id="aa19" class="graf graf--h3 graf--leading">Before You Go</h3><p name="e7d9" id="e7d9" class="graf graf--p graf-after--h3">The corresponding source code can be found here.</p><div name="63fb" id="63fb" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://github.com/abhinavsagar/Kaggle-tutorial" data-href="https://github.com/abhinavsagar/Kaggle-tutorial" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/abhinavsagar/Kaggle-tutorial"><strong class="markup--strong markup--mixtapeEmbed-strong">abhinavsagar/Kaggle-tutorial</strong><br><em class="markup--em markup--mixtapeEmbed-em">Sample notebooks for Kaggle competitions. Automatic segmentation of microscopy images is an important task in medical…</em>github.com</a><a href="https://github.com/abhinavsagar/Kaggle-tutorial" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="e2a191f1c7a2d883cee7f4b5846e46b7" data-thumbnail-img-id="0*4b05alCAlJAvEv76" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*4b05alCAlJAvEv76);"></a></div><h3 name="cee3" id="cee3" class="graf graf--h3 graf-after--mixtapeEmbed">Contacts</h3><p name="924e" id="924e" class="graf graf--p graf-after--h3">If you want to keep updated with my latest articles and projects <a href="https://medium.com/@abhinav.sagar" data-href="https://medium.com/@abhinav.sagar" class="markup--anchor markup--p-anchor" target="_blank">follow me on Medium</a>. These are some of my contacts details:</p><ul class="postList"><li name="47c9" id="47c9" class="graf graf--li graf-after--p"><a href="https://abhinavsagar.github.io" data-href="https://abhinavsagar.github.io" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Personal Website</a></li><li name="575a" id="575a" class="graf graf--li graf-after--li"><a href="https://in.linkedin.com/in/abhinavsagar4" data-href="https://in.linkedin.com/in/abhinavsagar4" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Linkedin</a></li><li name="6139" id="6139" class="graf graf--li graf-after--li"><a href="https://medium.com/@abhinav.sagar" data-href="https://medium.com/@abhinav.sagar" class="markup--anchor markup--li-anchor" target="_blank">Medium Profile</a></li><li name="2e6d" id="2e6d" class="graf graf--li graf-after--li"><a href="https://github.com/abhinavsagar" data-href="https://github.com/abhinavsagar" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">GitHub</a></li><li name="de97" id="de97" class="graf graf--li graf-after--li"><a href="https://www.kaggle.com/abhinavsagar" data-href="https://www.kaggle.com/abhinavsagar" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Kaggle</a></li></ul><p name="2d26" id="2d26" class="graf graf--p graf-after--li graf--trailing">Happy reading, happy learning and happy coding.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@abhinav.sagar" class="p-author h-card">Abhinav Sagar</a> on <a href="https://medium.com/p/eceb14a9ced4"><time class="dt-published" datetime="2019-06-19T18:11:57.283Z">June 19, 2019</time></a>.</p><p><a href="https://medium.com/@abhinav.sagar/nucleus-segmentation-using-u-net-eceb14a9ced4" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on April 28, 2021.</p></footer></article></body></html>